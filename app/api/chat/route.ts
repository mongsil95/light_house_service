import { NextRequest, NextResponse } from "next/server";
import OpenAI from "openai";
import { faqData, getBeachAdoptionAnswer } from "@/lib/faqData";
import { beachList } from "@/lib/beachData";

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// FAQ ë°ì´í„°ë¥¼ ì»¨í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
const faqContext = faqData
  .map((faq) => `Q: ${faq.question}\nA: ${faq.answer}\nì¹´í…Œê³ ë¦¬: ${faq.category}`)
  .join("\n\n");

// í•´ë³€ ë¦¬ìŠ¤íŠ¸ë¥¼ ì»¨í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ (ì§€ì—­ë³„ ê·¸ë£¹í•‘)
const beachContext = `
# ì…ì–‘ ê°€ëŠ¥í•œ í•´ë³€ ë¦¬ìŠ¤íŠ¸ (ì´ ${beachList.length}ê°œ)

**ì¸ì²œ/ê²½ê¸° ì§€ì—­**: ${beachList.filter(b => b.addr.includes('ì¸ì²œ') || b.addr.includes('ê²½ê¸°')).map(b => b.name).join(', ')}

**ê°•ì› ì§€ì—­**: ${beachList.filter(b => b.addr.includes('ê°•ì›')).map(b => b.name).join(', ')}

**ì¶©ì²­ ì§€ì—­**: ${beachList.filter(b => b.addr.includes('ì¶©ì²­') || b.addr.includes('ì¶©ë‚¨') || b.addr.includes('ì¶©ë¶')).map(b => b.name).join(', ')}

**ì „ë¼ ì§€ì—­**: ${beachList.filter(b => b.addr.includes('ì „ë¼') || b.addr.includes('ì „ë‚¨') || b.addr.includes('ì „ë¶')).map(b => b.name).join(', ')}

**ê²½ìƒ ì§€ì—­**: ${beachList.filter(b => b.addr.includes('ê²½ìƒ') || b.addr.includes('ê²½ë‚¨') || b.addr.includes('ê²½ë¶')).map(b => b.name).join(', ')}

**ë¶€ì‚°/ìš¸ì‚° ì§€ì—­**: ${beachList.filter(b => b.addr.includes('ë¶€ì‚°') || b.addr.includes('ìš¸ì‚°')).map(b => b.name).join(', ')}

**ì œì£¼ ì§€ì—­**: ${beachList.filter(b => b.addr.includes('ì œì£¼')).map(b => b.name).join(', ')}
`.trim();

const systemPrompt = `ë‹¹ì‹ ì€ 'ë“±ëŒ€(Lighthouse)'ê°€ ë˜ì–´ì„œ í•´ë³€ ì •í™”ë¥¼ í•˜ë ¤ëŠ” ì‚¬ëŒë“¤ì—ê²Œ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ëŠ” ì¹œì ˆí•œ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.

# ë“±ëŒ€ ì†Œê°œ
ë“±ëŒ€ëŠ” í•´ì–‘ í™˜ê²½ ë³´í˜¸ë¥¼ ìœ„í•œ ë‹¤ì–‘í•œ í™œë™ì„ ì§„í–‰í•˜ëŠ” ë‹¨ì²´ì…ë‹ˆë‹¤.
- ë°˜ë ¤í•´ë³€: í•´ë³€ì„ ë°˜ë ¤ë™ë¬¼ì²˜ëŸ¼ ì…ì–‘í•˜ì—¬ ì§€ì†ì ìœ¼ë¡œ ê°€ê¾¸ê³  ê´€ë¦¬í•˜ëŠ” í”„ë¡œê·¸ë¨. 2025ë…„ì—ëŠ” ì˜ë¦¬ê¸°ì—…, ë¹„ì˜ë¦¬ë‹¨ì²´, í•™êµ, ê³µê³µê¸°ê´€ì´ í•´ë³€ì„ ì…ì–‘í•˜ì—¬ ì •í™” í™œë™ì„ ì§„í–‰í–ˆìŠµë‹ˆë‹¤.
- í•´ë´„: í•´ì–‘ í™˜ê²½ ë³´í˜¸ë¥¼ ìœ„í•œ ë´‰ì‚¬ í™œë™ í”„ë¡œê·¸ë¨
- ì»¤ë®¤ë‹ˆí‹°: íšŒì›ë“¤ì´ ì†Œí†µí•˜ê³  ì •ë³´ë¥¼ ê³µìœ í•˜ëŠ” ê³µê°„

# ê¸°ë³¸ ì •ë³´
- ìš´ì˜ì‹œê°„: í‰ì¼ 09:30 - 17:00 (ì£¼ë§ ë° ê³µíœ´ì¼ ì œì™¸)
- ì „í™”: 070-8015-4120
- ì´ë©”ì¼: itaseoul@naver.com

${beachContext}

# FAQ ë°ì´í„°ë² ì´ìŠ¤
${faqContext}

# ì‘ë‹µ ê°€ì´ë“œë¼ì¸
1. ì‚¬ìš©ìì˜ ì§ˆë¬¸ì´ FAQ ë°ì´í„°ë² ì´ìŠ¤ì— ìˆëŠ” ê²½ìš°, í•´ë‹¹ ë‹µë³€ì„ ì°¸ê³ í•˜ì—¬ ì¹œì ˆí•˜ê²Œ ë‹µë³€í•˜ì„¸ìš”.
2. ë°˜ë ¤í•´ë³€ì€ ë°˜ë ¤ë™ë¬¼ê³¼ ê´€ë ¨ì´ ì—†ìŠµë‹ˆë‹¤. í•´ë³€ì„ ì…ì–‘í•˜ì—¬ ê´€ë¦¬í•˜ëŠ” í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤.
3. **íŠ¹ì • í•´ë³€ ì…ì–‘ ê°€ëŠ¥ ì—¬ë¶€ ì§ˆë¬¸ì‹œ ì¤‘ìš” ê·œì¹™:**
   - ìœ„ì˜ ì…ì–‘ ê°€ëŠ¥í•œ í•´ë³€ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜ë“œì‹œ í™•ì¸í•˜ì„¸ìš”
   - ë¦¬ìŠ¤íŠ¸ì— ìˆëŠ” í•´ë³€: "**[í•´ë³€ëª…]**ì€(ëŠ”) ì í•©ì„± í‰ê°€ë¥¼ ì™„ë£Œí•˜ì—¬ ì…ì–‘ì´ ê°€ëŠ¥í•œ í•´ë³€ì…ë‹ˆë‹¤. ë‹¤ë§Œ, ì…ì–‘ í¬ë§ ê¸°ê´€ì´ ë§ì„ ê²½ìš° ìƒí™©ì— ë”°ë¼ ë‹¤ë¥¸ í•´ë³€ì„ ì¶”ì²œë“œë¦´ ìˆ˜ ìˆëŠ” ì  ì–‘í•´ ë¶€íƒë“œë¦½ë‹ˆë‹¤."
   - ë¦¬ìŠ¤íŠ¸ì— ì—†ëŠ” í•´ë³€: "**[í•´ë³€ëª…]**ì€(ëŠ”) í˜„ì¬ ì…ì–‘ ì í•©ì„± í‰ê°€ê°€ ì§„í–‰ë˜ì§€ ì•Šì€ í•´ë³€ì…ë‹ˆë‹¤. ì…ì–‘ ì‹ ì²­ ì ‘ìˆ˜ í›„ ì í•©ì„± í‰ê°€ë¥¼ ê±°ì³ ì…ì–‘ ê°€ëŠ¥ ì—¬ë¶€ë¥¼ ê°œë³„ ì•ˆë‚´ë“œë¦´ ì˜ˆì •ì´ë©°, ë¶€ì í•©ìœ¼ë¡œ íŒë‹¨ë  ê²½ìš° ì‚¬ì „ì— ë³„ë„ ì—°ë½ì„ ë“œë ¤ ë‹¤ë¥¸ í•´ë³€ ì…ì–‘ì„ ì•ˆë‚´ë“œë¦¬ê² ìŠµë‹ˆë‹¤."
   - í•´ë³€ ì´ë¦„ì„ ì •í™•íˆ ì°¾ì„ ìˆ˜ ì—†ëŠ” ê²½ìš°: "ì…ì–‘ ì‹ ì²­ì„ ì›í•˜ì‹ ë‹¤ë©´, í•´ë‹¹ í•´ë³€ì´ ê¸°ì¡´ í•´ë³€ ë¦¬ìŠ¤íŠ¸ì— ìˆëŠ”ì§€ í™•ì¸í•´ë³´ì‹œê¸° ë°”ëë‹ˆë‹¤."
4. FAQì— ëª…í™•í•œ ë‹µë³€ì´ ì—†ëŠ” ê²½ìš°, ë‹¤ìŒê³¼ ê°™ì´ ì‘ë‹µí•˜ì„¸ìš”:
   "ì£„ì†¡í•©ë‹ˆë‹¤. í•´ë‹¹ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì´ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ğŸ˜¥
   
   ë” ìì„¸í•œ ë„ì›€ì´ í•„ìš”í•˜ì‹œë©´ ì‚¬ë¬´êµ­ìœ¼ë¡œ ë¬¸ì˜í•´ì£¼ì„¸ìš”."
   
5. ë‹µë³€ì— ì—°ë½ì²˜ ì •ë³´(ì „í™”ë²ˆí˜¸, ì´ë©”ì¼, ìš´ì˜ì‹œê°„)ë¥¼ ì§ì ‘ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”. ì—°ë½ì²˜ëŠ” ë³„ë„ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
6. í•­ìƒ ì¹œì ˆí•˜ê³  ê³µì†í•œ ë§íˆ¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
7. ì´ëª¨ì§€ë¥¼ ì ì ˆíˆ í™œìš©í•˜ì—¬ ì¹œê·¼í•œ ë¶„ìœ„ê¸°ë¥¼ ë§Œë“œì„¸ìš”.
8. ë‹µë³€ì€ ê°„ê²°í•˜ê³  ëª…í™•í•˜ê²Œ ì‘ì„±í•˜ì„¸ìš”.
9. ë“±ëŒ€ì˜ í”„ë¡œê·¸ë¨(ë°˜ë ¤í•´ë³€, í•´ë´„)ì— ëŒ€í•œ ê¸ì •ì ì¸ íƒœë„ë¥¼ ìœ ì§€í•˜ì„¸ìš”.`;

export async function POST(request: NextRequest) {
  try {
    const { message, conversationHistory } = await request.json();

    if (!process.env.OPENAI_API_KEY) {
      return NextResponse.json(
        {
          error: "API key not configured",
          response: "ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‚¬ë¬´êµ­ìœ¼ë¡œ ì§ì ‘ ë¬¸ì˜í•´ì£¼ì„¸ìš”.",
          showContact: true,
        },
        { status: 200 }
      );
    }

    // OpenAI API í˜¸ì¶œ
    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        { role: "system", content: systemPrompt },
        ...conversationHistory.map((msg: any) => ({
          role: msg.sender === "user" ? "user" : "assistant",
          content: msg.text,
        })),
        { role: "user", content: message },
      ],
      temperature: 0.7,
      max_tokens: 500,
    });

    const responseText =
      completion.choices[0].message.content || "ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";

    // "ì£„ì†¡í•©ë‹ˆë‹¤" ë˜ëŠ” "ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ì—°ë½ì²˜ í‘œì‹œ
    const showContact =
      responseText.includes("ì£„ì†¡í•©ë‹ˆë‹¤") &&
      (responseText.includes("ì¤€ë¹„ë˜ì§€") || responseText.includes("ì¤€ë¹„ ë˜ì§€"));

    return NextResponse.json({
      response: responseText,
      showContact: showContact,
    });
  } catch (error: any) {
    console.error("OpenAI API Error:", error);

    return NextResponse.json(
      {
        response:
          "ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. ğŸ˜¥\n\në¬¸ì œê°€ ê³„ì†ë˜ë©´ ì‚¬ë¬´êµ­ìœ¼ë¡œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.",
        showContact: true,
      },
      { status: 200 }
    );
  }
}
